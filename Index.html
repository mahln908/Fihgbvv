<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rádio Gospel</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .radio-container {
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 30px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .radio-display {
            background-color: #111;
            border: 3px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .station-name {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .now-playing {
            font-size: 16px;
            margin-top: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .artist {
            font-weight: bold;
        }
        
        .radio-effect {
            position: absolute;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(255, 255, 255, 0.05),
                rgba(255, 255, 255, 0.05) 1px,
                transparent 1px,
                transparent 3px
            );
            pointer-events: none;
            z-index: 1;
        }
        
        .loading-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .frequency-display {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div class="loading-animation" id="loading">
        <div class="spinner"></div>
        <div>Sintonizando a Rádio Gospel...</div>
    </div>

    <div class="radio-container">
        <div class="radio-effect"></div>
        <div class="station-name">RÁDIO GOSPEL</div>
        <div class="radio-display">
            <div id="now-playing">Procurando músicas gospel...</div>
        </div>
        <div class="frequency-display">FM 107.7</div>
    </div>

    <div id="player"></div>

    <script>
        // Configuração da API do YouTube
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        let player;
        let currentVideoIndex = 0;
        let gospelPlaylist = [];
        let playedVideos = [];
        
        // Palavras-chave para músicas gospel
        const gospelKeywords = [
            "música gospel",
            "louvor e adoração",
            "música cristã",
            "gospel brasileiro",
            "hinos evangélicos",
            "adoração",
            "fernandinho",
            "aline barros",
            "anderson freire",
            "davi sapper",
            "ludmila ferber",
            "diante do trono",
            "israel e rodolffo",
            "casa worship",
            "gabriela rocha"
        ];

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '0',
                width: '0',
                playerVars: {
                    autoplay: 1,
                    controls: 0,
                    disablekb: 1,
                    fs: 0,
                    modestbranding: 1,
                    rel: 0
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            // Carrega músicas gospel quando o player estiver pronto
            carregarMusicasGospel();
            
            // Configura o service worker para notificações
            configurarServiceWorker();
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                tocarProximaMusica();
            }
            
            // Atualiza notificação quando a música muda
            if (event.data === YT.PlayerState.PLAYING) {
                atualizarMediaSession();
            }
        }

        function carregarMusicasGospel() {
            const keywordAleatoria = gospelKeywords[Math.floor(Math.random() * gospelKeywords.length)];
            
            // Limita a 50 resultados e ordena por visualizações
            gapi.client.youtube.search.list({
                part: 'snippet',
                q: keywordAleatoria,
                type: 'video',
                videoCategoryId: '10', // Categoria de música
                maxResults: 50,
                order: 'viewCount'
            }).then(function(response) {
                const videos = response.result.items;
                
                // Filtra apenas vídeos que ainda não foram tocados
                const novosVideos = videos.filter(video => !playedVideos.includes(video.id.videoId));
                
                if (novosVideos.length > 0) {
                    gospelPlaylist = novosVideos.map(video => video.id.videoId);
                    
                    // Embaralha a playlist para ser aleatória
                    gospelPlaylist = embaralharArray(gospelPlaylist);
                    
                    // Toca a primeira música
                    tocarProximaMusica();
                    
                    // Esconde a animação de carregamento
                    setTimeout(() => {
                        document.getElementById('loading').style.display = 'none';
                    }, 2000);
                } else {
                    // Se todas as músicas já foram tocadas, reseta a lista
                    playedVideos = [];
                    carregarMusicasGospel();
                }
            }).catch(function(error) {
                console.error("Erro ao carregar músicas:", error);
                document.getElementById('now-playing').textContent = "Erro ao carregar músicas. Tentando novamente...";
                setTimeout(carregarMusicasGospel, 5000);
            });
        }

        function embaralharArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function tocarProximaMusica() {
            if (gospelPlaylist.length === 0) {
                carregarMusicasGospel();
                return;
            }
            
            currentVideoIndex = (currentVideoIndex + 1) % gospelPlaylist.length;
            const videoId = gospelPlaylist[currentVideoIndex];
            player.loadVideoById(videoId);
            playedVideos.push(videoId);
            
            // Busca detalhes do vídeo para exibir
            buscarDetalhesVideo(videoId);
        }

        function buscarDetalhesVideo(videoId) {
            gapi.client.youtube.videos.list({
                part: 'snippet',
                id: videoId
            }).then(function(response) {
                const video = response.result.items[0];
                if (video) {
                    const titulo = video.snippet.title;
                    const canal = video.snippet.channelTitle;
                    
                    document.getElementById('now-playing').innerHTML = `
                        TOCANDO AGORA:<br>
                        <span class="song-title">${titulo}</span><br>
                        <span class="artist">${canal}</span>
                    `;
                    
                    // Efeito de estática de rádio
                    efeitoEstatica();
                }
            }).catch(function(error) {
                console.error("Erro ao buscar detalhes:", error);
            });
        }

        function efeitoEstatica() {
            const display = document.querySelector('.radio-display');
            display.style.color = 'transparent';
            display.style.textShadow = '0 0 8px white';
            
            setTimeout(() => {
                display.style.color = 'white';
                display.style.textShadow = 'none';
            }, 300);
        }

        function configurarServiceWorker() {
            if ('serviceWorker' in navigator && 'Notification' in window) {
                navigator.serviceWorker.register('sw.js').then(function(registration) {
                    console.log('ServiceWorker registrado com sucesso');
                    
                    // Solicita permissão para notificações
                    Notification.requestPermission();
                }).catch(function(err) {
                    console.log('Falha no registro do ServiceWorker: ', err);
                });
            }
            
            // Configura Media Session API para controles na tela de bloqueio
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', function() {
                    player.playVideo();
                });
                
                navigator.mediaSession.setActionHandler('pause', function() {
                    player.pauseVideo();
                });
            }
        }

        function atualizarMediaSession() {
            if ('mediaSession' in navigator) {
                const tituloMusica = document.querySelector('.song-title')?.textContent || 'Música Gospel';
                const artista = document.querySelector('.artist')?.textContent || 'Rádio Gospel';
                
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: tituloMusica,
                    artist: artista,
                    artwork: [
                        { src: 'https://i.imgur.com/JNZF5Bw.jpg', sizes: '512x512', type: 'image/jpg' }
                    ]
                });
            }
        }

        // Carrega a API do Google Client
        function carregarGoogleAPI() {
            const script = document.createElement('script');
            script.src = 'https://apis.google.com/js/client.js';
            script.onload = function() {
                gapi.load('client', function() {
                    gapi.client.init({
                        'apiKey': 'AIzaSyC_8CHxOvjcNCs36B-Omt3v5VjzVAazdIw',
                        'discoveryDocs': ['https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest']
                    }).then(function() {
                        console.log("API do YouTube carregada com sucesso");
                    }).catch(function(error) {
                        console.error("Erro ao carregar API:", error);
                        document.getElementById('now-playing').textContent = "Erro ao conectar com o YouTube. Recarregue a página.";
                    });
                });
            };
            document.body.appendChild(script);
        }
        
        // Inicia tudo quando a página carregar
        window.onload = carregarGoogleAPI;
    </script>
</body>
</html>
